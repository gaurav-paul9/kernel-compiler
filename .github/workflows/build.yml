name: OnePlus SM8550 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Empty Workspace
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    ###########################################################################
    #                            CLONE KERNEL SOURCES                         #
    ###########################################################################

    - name: Clone Main Kernel Source
      run: |
        mkdir -p kernel/oneplus
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone Kernel Modules
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    ###########################################################################
    #                              SYSTEM SETUP                               #
    ###########################################################################

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gperf libncurses5-dev libssl-dev libxml2-utils \
          python3 python-is-python3 unzip xz-utils zip zlib1g-dev \
          libelf-dev dwarves

    - name: Create 8GB Swap
      run: |
        sudo swapoff -a || true
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Download AOSP Clang r547379
      run: |
        mkdir -p prebuilts/clang
        cd prebuilts/clang
        curl -L -o clang.tar.gz \
          https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz
        mkdir -p clang-r547379
        tar -xf clang.tar.gz -C clang-r547379
        cd $GITHUB_WORKSPACE

    - name: Export Clang to PATH
      run: echo "$GITHUB_WORKSPACE/prebuilts/clang/clang-r547379/bin" >> $GITHUB_PATH

    - name: Prepare Out Directory
      run: mkdir -p out

    ###########################################################################
    #                         CONFIG GENERATION (CLEAN FIRST)                 #
    ###########################################################################

    - name: Diagnostic - kernel tree before cleaning
      run: |
        echo "=== kernel/oneplus/sm8550 before mrproper ==="
        ls -la kernel/oneplus/sm8550 | sed -n '1,120p'

    - name: Clean Kernel Source (mrproper)
      run: |
        cd kernel/oneplus/sm8550
        # Fully clean the source tree so merge_config and make won't complain.
        make mrproper
        # Ensure no stray generated files remain
        rm -f .config
        rm -rf include/config include/generated
        rm -f scripts/kconfig/.tmp* || true
        cd $GITHUB_WORKSPACE

    - name: Diagnostic - kernel tree after cleaning
      run: |
        echo "=== kernel/oneplus/sm8550 after mrproper ==="
        ls -la kernel/oneplus/sm8550 | sed -n '1,120p'

    - name: Generate gki_defconfig (Base) into out
      run: |
        make -C kernel/oneplus/sm8550 \
          O=$GITHUB_WORKSPACE/out \
          gki_defconfig

    - name: Merge all device config fragments (4-layer merge)
      run: |
        cd kernel/oneplus/sm8550
        # Merge in correct order: base then vendor fragments then device vendor then debugfs
        scripts/kconfig/merge_config.sh -m \
          arch/arm64/configs/gki_defconfig \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/vendor_kalama.config \
          arch/arm64/configs/vendor/debugfs.config
        # Move final merged config to the out directory (where make expects it)
        mv .config $GITHUB_WORKSPACE/out/.config
        cd $GITHUB_WORKSPACE

    - name: Diagnostic - show merged config summary
      run: |
        echo "=== head of merged out/.config ==="
        head -n 120 out/.config || true
        echo "=== tail of merged out/.config ==="
        tail -n 60 out/.config || true

    - name: Cleanup merge_config temporary files (source)
      run: |
        cd kernel/oneplus/sm8550
        # remove any generated files that merge_config might have left in the source
        rm -f .config
        rm -rf include/config include/generated
        rm -f scripts/kconfig/.tmp*
        cd $GITHUB_WORKSPACE

    - name: Finalize Config (olddefconfig)
      run: |
        make -C kernel/oneplus/sm8550 \
          O=$GITHUB_WORKSPACE/out \
          olddefconfig

    ###########################################################################
    #                             KERNEL BUILD                                #
    ###########################################################################

    - name: Build Kernel
      env:
        # optional: enable ccache for speed if available
        CCACHE_DIR: ${{ runner.temp }}/ccache
      run: |
        # adjust -j if you want to limit parallelism
        make -C kernel/oneplus/sm8550 \
          O=$GITHUB_WORKSPACE/out \
          -j$(nproc)

    ###########################################################################
    #                              PACKAGE OUTPUT                             #
    ###########################################################################

    - name: Package Kernel
      run: |
        cd out/arch/arm64/boot
        zip -r9 $GITHUB_WORKSPACE/kernel.zip \
          Image Image.gz* dtb* dtbo* 2>/dev/null || true
        cd $GITHUB_WORKSPACE

    - name: Upload Kernel Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: kernel.zip
