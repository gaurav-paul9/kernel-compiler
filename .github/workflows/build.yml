name: Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install -y bc bison flex build-essential ccache curl git \
          libssl-dev libelf-dev dwarves python3 python3-pip unzip

    - name: Prepare workspace
      run: |
        mkdir -p kernel/oneplus
        mkdir -p qc-prebuilts/clang
        mkdir -p toolchains

    - name: Clone OnePlus 12R kernel tree
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone OnePlus sm8550-modules (oplus extras)
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Fix symlink structure
      run: |
        cd kernel/oneplus/sm8550/kernel/oplus_cpu
        rm -f thermal
        ln -sf ../../../sm8550-modules/oplus/kernel/cpu/thermal thermal
        cd ../../../../..

    - name: Download Qualcomm Clang
      run: |
        cd qc-prebuilts/clang

        wget https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86/-/archive/c420e3ab93e5/clang-host-linux-x86.tar.gz

        tar -xf clang-host-linux-x86.tar.gz
        mv clang-host-linux-x86*/ clang

    - name: Export Clang paths
      run: |
        echo "Using QC Clang:"
        export CLANG_PATH=$GITHUB_WORKSPACE/qc-prebuilts/clang/clang
        export PATH=$CLANG_PATH/bin:$PATH
        clang --version

    - name: Prepare defconfig
      run: |
        cd kernel/oneplus/sm8550

        echo "Running mrproper (fixes source tree not clean)"
        make ARCH=arm64 mrproper

        mkdir -p out

        echo "Running gki_defconfig"
        make O=out ARCH=arm64 gki_defconfig

        echo "Merging vendor configs"
        bash scripts/kconfig/merge_config.sh -m \
          out/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        echo "Running olddefconfig"
        make O=out ARCH=arm64 olddefconfig

    - name: Build Kernel
      run: |
        cd kernel/oneplus/sm8550

        export CLANG_PATH=$GITHUB_WORKSPACE/qc-prebuilts/clang/clang
        export PATH=$CLANG_PATH/bin:$PATH

        export ARCH=arm64
        export SUBARCH=arm64
        export LLVM=1
        export LLVM_IAS=1

        make -j$(nproc) O=out ARCH=arm64 CC=clang

    - name: Package AnyKernel3
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git AnyKernel
        cd AnyKernel
        cp ../kernel/oneplus/sm8550/out/arch/arm64/boot/Image .
        zip -r kernel.zip ./*

    - name: Upload to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        files: AnyKernel/kernel.zip
        tag_name: build-${{ github.run_number }}
        name: Kernel Build ${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
