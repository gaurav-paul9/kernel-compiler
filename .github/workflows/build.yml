name: Kernel-Compiler

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison flex build-essential zip \
            gcc-aarch64-linux-gnu libc6-dev libncurses-dev \
            g++-aarch64-linux-gnu python3 wget jq rsync cpio \
            libssl-dev python-is-python3 mkbootimg

    - name: Setup Swap (6GB)
      run: |
        sudo fallocate -l 6G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Download AOSP Clang r547379
      run: |
        mkdir -p clang
        cd clang
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
        tar -xf clang.tar.gz
        cd ..

    - name: Export Build Vars
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CLANG_PATH=$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/clang/bin:$PATH" >> $GITHUB_ENV

    - name: Clone Kernel Sources
      run: |
        mkdir -p kernel/oneplus
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git -b lineage-23.0 kernel/oneplus/sm8550 --depth=1
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Create OUT Directory
      run: |
        mkdir out

    - name: Step 1 — Clean Tree
      run: |
        make -C kernel/oneplus/sm8550 mrproper

    - name: Step 2 — Base GKI Config
      run: |
        make -C kernel/oneplus/sm8550 ARCH=arm64 O=$GITHUB_WORKSPACE/out gki_defconfig

    - name: Step 3 — Merge Vendor Configs
      run: |
        cd kernel/oneplus/sm8550
        KCONFIG_CONFIG=$GITHUB_WORKSPACE/out/.config \
        scripts/kconfig/merge_config.sh -m \
            arch/arm64/configs/gki_defconfig \
            arch/arm64/configs/vendor/kalama_GKI.config \
            arch/arm64/configs/vendor/oplus/kalama_GKI.config \
            arch/arm64/configs/vendor/debugfs.config

    - name: Step 4 — Finalize Config
      run: |
        make -C kernel/oneplus/sm8550 ARCH=arm64 O=$GITHUB_WORKSPACE/out olddefconfig

    - name: Step 5 — Build Kernel
      run: |
        make -C kernel/oneplus/sm8550 ARCH=arm64 O=$GITHUB_WORKSPACE/out -j$(nproc)

    - name: Copy Kernel Image + DTBs
      run: |
        mkdir final
        cp out/arch/arm64/boot/Image final/Image
        find out/arch/arm64/boot/dts -name "*.dtb" -exec cat {} + > final/dtb

    - name: Package boot.img
      run: |
        mkbootimg \
          --kernel final/Image \
          --dtb final/dtb \
          --pagesize 4096 \
          --base 0x00000000 \
          --output final/boot.img

    - name: Upload Output
      uses: actions/upload-artifact@v4
      with:
        name: compiled-kernel
        path: final/boot.img
