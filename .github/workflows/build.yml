name: OnePlus SM8550 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Empty Workspace
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    ###########################################################################
    #                            CLONE KERNEL SOURCES                         #
    ###########################################################################

    - name: Clone Main Kernel Source
      run: |
        mkdir -p kernel/oneplus
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone Kernel Modules
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    ###########################################################################
    #                              SYSTEM SETUP                               #
    ###########################################################################

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gperf libncurses5-dev libssl-dev libxml2-utils \
          python3 python-is-python3 unzip xz-utils zip zlib1g-dev \
          libelf-dev dwarves mkbootimg

    - name: Create 8GB Swap
      run: |
        sudo swapoff -a || true
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Download AOSP Clang r547379
      run: |
        mkdir -p prebuilts/clang
        cd prebuilts/clang
        curl -L -o clang.tar.gz \
          https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz
        mkdir clang-r547379
        tar -xf clang.tar.gz -C clang-r547379

    - name: Export Clang to PATH
      run: echo "$PWD/prebuilts/clang/clang-r547379/bin" >> $GITHUB_PATH

    - name: Prepare Out Directory
      run: mkdir -p out

    ###########################################################################
    #                         CONFIG GENERATION (4 FILES)                     #
    ###########################################################################

    - name: Merge all 4 defconfigs
      run: |
        cd kernel/oneplus/sm8550
        scripts/kconfig/merge_config.sh -m \
          arch/arm64/configs/gki_defconfig \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config \
          -O $GITHUB_WORKSPACE/out

    - name: Finalize Config (olddefconfig)
      run: |
        make -C kernel/oneplus/sm8550 O=$GITHUB_WORKSPACE/out olddefconfig

    ###########################################################################
    #                             KERNEL BUILD                                 #
    ###########################################################################

    - name: Build Kernel
      run: |
        make -C kernel/oneplus/sm8550 O=$GITHUB_WORKSPACE/out -j$(nproc)

    ###########################################################################
    #                             PACKAGE OUTPUT                               #
    ###########################################################################

    - name: Package Kernel Files
      run: |
        cd out/arch/arm64/boot
        zip -r9 $GITHUB_WORKSPACE/kernel.zip \
          Image Image.gz* dtb* dtbo* 2>/dev/null || true

    ###########################################################################
    #                               BOOT.IMG                                  
    ###########################################################################

    - name: Build boot.img
      run: |
        mkdir -p bootimg
        mkbootimg \
          --kernel out/arch/arm64/boot/Image.gz \
          --ramdisk out/ramdisk \
          --dtb out/arch/arm64/boot/dtb \
          --pagesize 4096 \
          --base 0x00000000 \
          --cmdline "" \
          -o bootimg/boot.img

    ###########################################################################
    #                             ANYKERNEL3 ZIP                               #
    ###########################################################################

    - name: Clone AnyKernel3 Template
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git anykernel
        rm -rf anykernel/.git

    - name: Copy Kernel Files into AnyKernel3
      run: |
        cp out/arch/arm64/boot/Image.gz anykernel/
        cp out/arch/arm64/boot/dtb* anykernel/ || true
        cp out/arch/arm64/boot/dtbo* anykernel/ || true

    - name: Create AnyKernel ZIP
      run: |
        cd anykernel
        zip -r9 $GITHUB_WORKSPACE/AnyKernel3.zip ./*

    ###########################################################################
    #                      UPLOAD TO GITHUB RELEASES                           #
    ###########################################################################

    - name: Create GitHub Release & Upload Files
      uses: softprops/action-gh-release@v2
      with:
        name: "SM8550 Kernel Build"
        tag_name: "build-${{ github.run_id }}"
        files: |
          kernel.zip
          bootimg/boot.img
          AnyKernel3.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
