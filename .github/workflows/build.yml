name: Build OnePlus 12R Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v3

    ## ============================================================
    ## 1) Install Dependencies
    ## ============================================================
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi git kmod libelf-dev libssl-dev libarchive-tools \
          llvm lld python3 python3-pip wget zstd

    ## ============================================================
    ## 2) Clone Kernel Sources
    ## ============================================================
    - name: Clone kernel sources
      run: |
        mkdir -p kernel/oneplus
        cd kernel/oneplus
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 sm8550 --depth=1

        # Clone modules tree (needed for symlink)
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 sm8550-modules --depth=1

    ## ============================================================
    ## 3) Download Qualcomm Clang (Correctly)
    ## ============================================================
    - name: Download Qualcomm Clang prebuilts
      run: |
        mkdir -p qc-prebuilts/clang
        cd qc-prebuilts/clang

        echo "Downloading QC Clang prebuilts..."
        wget -q \
        https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86/-/archive/c420e3ab93e51a2f2ab4f8e8b517463c34a7e8bd/clang-host-linux-x86.tar.gz

        echo "Detecting extracted folder name..."
        EXTRACTED=$(tar -tf clang-host-linux-x86.tar.gz | head -1 | cut -f1 -d"/")

        echo "Extracting..."
        tar -xzf clang-host-linux-x86.tar.gz

        echo "Renaming folder â†’ clang/"
        mv "$EXTRACTED" clang

        echo "Final Clang Path:"
        ls -al clang/bin

    ## ============================================================
    ## 4) Build Kernel
    ## ============================================================
    - name: Build kernel
      run: |
        cd kernel/oneplus/sm8550

        export CLANG_PATH=$GITHUB_WORKSPACE/qc-prebuilts/clang/clang
        export PATH=$CLANG_PATH/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out

        echo "Using Clang:"
        clang --version

        # Clean source tree (FIXES 'tree not clean' error)
        echo "Running mrproper..."
        make ARCH=arm64 mrproper

        mkdir -p out

        echo "Running gki_defconfig..."
        make O=$O ARCH=arm64 gki_defconfig

        echo "Merging vendor configs..."
        bash scripts/kconfig/merge_config.sh -m \
          out/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        echo "Running olddefconfig..."
        make O=$O ARCH=arm64 olddefconfig

        echo "Starting kernel compilation..."
        make -j$(nproc) O=$O ARCH=arm64 CC=clang

    ## ============================================================
    ## 5) Upload Kernel Image
    ## ============================================================
    - name: Upload kernel Image
      uses: actions/upload-artifact@v3
      with:
        name: kernel-image
        path: kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz
