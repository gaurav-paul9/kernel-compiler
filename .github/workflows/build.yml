name: OnePlus SM8550 Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    # ---------------------------------------------------------------
    # Clone kernel source
    # ---------------------------------------------------------------
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: gaurav-paul9/android_kernel_oneplus_sm8550
        ref: lineage-23.0
        path: kernel/oneplus/sm8550

    # ---------------------------------------------------------------
    # Clone kernel modules
    # ---------------------------------------------------------------
    - name: Checkout Kernel Modules
      uses: actions/checkout@v4
      with:
        repository: LineageOS/android_kernel_oneplus_sm8550-modules
        ref: lineage-23.0
        path: kernel/oneplus/sm8550-modules

    # ---------------------------------------------------------------
    # Install build dependencies
    # ---------------------------------------------------------------
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison flex git clang llvm lld \
           libssl-dev cmake python3 python3-pip libncurses5-dev \
           libelf-dev build-essential ccache wget curl unzip

    # ---------------------------------------------------------------
    # Add 8GB Swap to prevent OOM
    # ---------------------------------------------------------------
    - name: Add 6GB Swap
      run: |
        sudo swapoff -a
        sudo fallocate -l 6G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    # ---------------------------------------------------------------
    # Download Clang r547379
    # ---------------------------------------------------------------
    - name: Download AOSP Clang r547379
      run: |
        mkdir -p $GITHUB_WORKSPACE/clang-r547379
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
        tar -xf clang.tar.gz -C clang-r547379

    # ---------------------------------------------------------------
    # Export all environment variables
    # ---------------------------------------------------------------
    - name: Export Build Environment
      run: |
        echo "PATH=$GITHUB_WORKSPACE/clang-r547379/bin:$PATH" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/clang-r547379/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "AS=clang" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV
        echo "READELF=llvm-readelf" >> $GITHUB_ENV

        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_COMPAT=arm-linux-gnueabi-" >> $GITHUB_ENV

        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV

    # ---------------------------------------------------------------
    # Build Kernel
    # ---------------------------------------------------------------
    - name: Build Kernel
      working-directory: kernel/oneplus/sm8550
      run: |
        make mrproper
        rm -rf out
        mkdir out

        make ARCH=arm64 O=out gki_defconfig

        KCONFIG_CONFIG=out/.config \
        scripts/kconfig/merge_config.sh -m \
            arch/arm64/configs/gki_defconfig \
            arch/arm64/configs/vendor/kalama_GKI.config \
            arch/arm64/configs/vendor/oplus/kalama_GKI.config \
            arch/arm64/configs/vendor/debugfs.config

        make ARCH=arm64 O=out olddefconfig
        make ARCH=arm64 O=out -j$(nproc)

    # ---------------------------------------------------------------
    # Build Kernel Modules
    # ---------------------------------------------------------------
    - name: Build Kernel Modules
      working-directory: kernel/oneplus/sm8550
      run: |
        make ARCH=arm64 O=out modules -j$(nproc)
        mkdir -p $GITHUB_WORKSPACE/modules_out
        cp -r out/lib/modules/* $GITHUB_WORKSPACE/modules_out/

    # ---------------------------------------------------------------
    # Upload Kernel Artifacts
    # ---------------------------------------------------------------
    - name: Upload Kernel Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Images
        path: |
          kernel/oneplus/sm8550/out/arch/arm64/boot/Image
          kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz
          kernel/oneplus/sm8550/out/arch/arm64/boot/dts/**/*.dtb
          kernel/oneplus/sm8550/out/arch/arm64/boot/dts/**/*.dtbo

    # ---------------------------------------------------------------
    # Upload Kernel Modules
    # ---------------------------------------------------------------
    - name: Upload Kernel Modules
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Modules
        path: modules_out
