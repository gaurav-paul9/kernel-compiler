name: Build OnePlus 12R Kernel (QC Clang)

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex git wget \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi g++-aarch64-linux-gnu g++-arm-linux-gnueabi \
          libssl-dev libncurses-dev libelf-dev dwarves python3 python3-distutils zip unzip zstd

    - name: Prepare kernel dirs
      run: |
        mkdir -p kernel/oneplus
        mkdir -p qc-prebuilts/clang

    - name: Clone kernel + modules (sm8550)
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1
        ls -la kernel/oneplus

    - name: Download QC Clang (robust extraction)
      run: |
        mkdir -p qc-prebuilts/clang
        cd qc-prebuilts/clang

        # download the exact archive referenced in manifest commit
        URL="https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86/-/archive/c420e3ab93e51a2f2ab4f8e8b517463c34a7e8bd/clang-host-linux-x86.tar.gz"
        echo "Downloading: $URL"
        wget -q --show-progress "$URL" -O clang-host-linux-x86.tar.gz

        # detect first-level folder inside the tarball and extract
        EXTRACTED=$(tar -tf clang-host-linux-x86.tar.gz | head -n1 | cut -f1 -d"/")
        tar -xzf clang-host-linux-x86.tar.gz
        # if extracted folder exists, rename it to 'clang' for predictable path
        if [ -d "$EXTRACTED" ]; then
          mv "$EXTRACTED" clang
        else
          # fallback: try to find some directory produced by extraction
          DIRFOUND=$(find . -maxdepth 2 -type d -name "*clang*" | head -n1 || true)
          if [ -n "$DIRFOUND" ]; then
            mv "$DIRFOUND" clang
          else
            echo "::error::Could not find extracted clang folder"
            ls -la
            exit 1
          fi
        fi
        echo "Clang installed at: $(pwd)/clang"
        ls -la clang/bin | sed -n '1,120p'

    - name: Detect clang and add to PATH
      id: detect_clang
      run: |
        CLANG_BIN=$(find qc-prebuilts/clang/clang -type f -name clang -perm /111 2>/dev/null | head -n1 || true)
        if [ -z "$CLANG_BIN" ]; then
          echo "::error::clang binary not found under qc-prebuilts/clang/clang"
          find qc-prebuilts/clang -maxdepth 4 -type f -print || true
          exit 1
        fi
        CLANG_DIR=$(dirname "$CLANG_BIN")
        echo "clang_dir=$CLANG_DIR" >> $GITHUB_OUTPUT
        echo "$CLANG_DIR" >> $GITHUB_PATH
        # also add kernel-build-tools if present
        if [ -d qc-prebuilts/kernel-build-tools/bin ]; then
          echo "$PWD/qc-prebuilts/kernel-build-tools/bin" >> $GITHUB_PATH
        fi

    - name: Verify clang
      run: |
        echo "clang -> $(which clang || true)"
        clang --version | sed -n '1,4p' || true

    - name: Clean kernel source (mrproper) â€” avoids 'source tree not clean'
      working-directory: kernel/oneplus/sm8550
      run: |
        git reset --hard
        git clean -fdx
        make ARCH=arm64 mrproper || true
        rm -rf out || true
        echo "clean done"

    - name: Create CI fragment & fix symlink (after clean)
      working-directory: kernel/oneplus/sm8550
      run: |
        # ensure symlink points at modules copy
        mkdir -p kernel/oplus_cpu || true
        rm -f kernel/oplus_cpu/thermal || true
        ln -s ../../../sm8550-modules/oplus/kernel/cpu/thermal kernel/oplus_cpu/thermal || true
        ls -l kernel/oplus_cpu || true

        mkdir -p ci_fragments
        cat > ci_fragments/disable_oplus_ci.config <<'EOF'
# CI-only overrides
# CONFIG_OPLUS_FEATURE_DUMP_DEVICE_INFO is not set
# CONFIG_OPLUS_FEATURE_THEIA is not set
# CONFIG_OPLUS_FEATURE_FEEDBACK is not set
# CONFIG_DEBUG_INFO_BTF is not set
EOF
        echo "ci fragment created:"
        sed -n '1,120p' ci_fragments/disable_oplus_ci.config

    - name: Create base config and merge vendor configs
      working-directory: kernel/oneplus/sm8550
      run: |
        export O=out
        mkdir -p $O
        make O=$O ARCH=arm64 gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          $O/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config \
          ci_fragments/disable_oplus_ci.config

        make O=$O ARCH=arm64 olddefconfig

    - name: Build kernel + modules (QC clang, LLVM)
      working-directory: kernel/oneplus/sm8550
      env:
        ARCH: arm64
        O: out
      run: |
        CLANG_DIR="${{ steps.detect_clang.outputs.clang_dir }}"
        export PATH="$CLANG_DIR:$GITHUB_WORKSPACE/qc-prebuilts/kernel-build-tools/bin:$PATH"

        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CLANG_TRIPLE=aarch64-linux-gnu-

        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip

        KCFLAGS="-Wno-frame-larger-than="

        make -j$(nproc) O=$O ARCH=arm64 CC=clang LD=ld.lld KCFLAGS="$KCFLAGS"

        rm -rf modules_tmp || true
        mkdir -p modules_tmp
        make O=$O ARCH=arm64 modules_install INSTALL_MOD_PATH=$PWD/modules_tmp

    - name: Package AnyKernel3 (flashable ZIP)
      working-directory: kernel/oneplus/sm8550
      run: |
        rm -rf AnyKernel || true
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel

        IMG=""
        if [ -f out/arch/arm64/boot/Image.gz ]; then
          IMG=out/arch/arm64/boot/Image.gz
        elif [ -f out/arch/arm64/boot/Image ]; then
          IMG=out/arch/arm64/boot/Image
        elif [ -f out/arch/arm64/boot/vmlinuz ]; then
          IMG=out/arch/arm64/boot/vmlinuz
        fi

        if [ -n "$IMG" ]; then
          cp "$IMG" AnyKernel/ || true
        else
          echo "::warning::Kernel image not found; packaging may be incomplete"
        fi

        if [ -f out/arch/arm64/boot/dtbo.img ]; then
          cp out/arch/arm64/boot/dtbo.img AnyKernel/ || true
        fi

        mkdir -p AnyKernel/modules
        if [ -d modules_tmp/lib/modules ]; then
          cp -r modules_tmp/lib/modules/* AnyKernel/modules/ || true
        fi

        cd AnyKernel
        zip -r9 "../OnePlus12R-Kernel-$(date -u +%Y%m%dT%H%M%SZ).zip" ./* -x .git README.md || true
        cd ..

    - name: Upload flashable ZIP (artifact)
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus12R-Kernel
        path: OnePlus12R-Kernel-*.zip

    - name: Also upload kernel Image separately (artifact)
      uses: actions/upload-artifact@v4
      with:
        name: kernel-image
        path: kernel/oneplus/sm8550/out/arch/arm64/boot/Image*  # matches Image or Image.gz
