name: OnePlus 12R Kernel Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout kernel-compiler repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison flex build-essential zip \
          libssl-dev dwarves libelf-dev python3

    # ----------------------------------------------------------
    # DOWNLOAD QUALCOMM PREBUILT CLANG + BUILD TOOLS
    # ----------------------------------------------------------
    - name: Download Qualcomm Clang + Build Tools
      run: |
        mkdir -p qc-prebuilts

        echo "Downloading Qualcomm Clang…"
        git clone --depth=1 \
          https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 \
          qc-prebuilts/clang

        echo "Downloading QC Kernel Build Tools…"
        git clone --depth=1 \
          https://git.codelinaro.org/clo/la/kernel/prebuilts/build-tools \
          qc-prebuilts/kernel-build-tools

    # ----------------------------------------------------------
    # CLONE KERNEL SOURCES
    # ----------------------------------------------------------
    - name: Clone OnePlus 12R Kernel Sources
      run: |
        mkdir -p kernel/oneplus
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

        echo "Cloning sm8550-modules…"
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    # ----------------------------------------------------------
    # FIX SYMLINKS INSIDE KERNEL TREE
    # ----------------------------------------------------------
    - name: Fix OPlus symlinks
      working-directory: kernel/oneplus/sm8550
      run: |
        echo "Fixing thermal symlink…"
        rm -f kernel/oplus_cpu/thermal
        ln -s ../../../sm8550-modules/oplus/kernel/cpu/thermal kernel/oplus_cpu/thermal

    # ----------------------------------------------------------
    # EXPORT BUILD ENVIRONMENT
    # ----------------------------------------------------------
    - name: Configure Environment
      run: |
        export CLANG_PATH=$GITHUB_WORKSPACE/qc-prebuilts/clang
        export PATH=$CLANG_PATH/bin:$PATH

        echo "CLANG: $(clang --version)"

    # ----------------------------------------------------------
    # START KERNEL BUILD
    # ----------------------------------------------------------
    - name: Build Kernel
      working-directory: kernel/oneplus/sm8550
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out

        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

        export PATH=$GITHUB_WORKSPACE/qc-prebuilts/clang/bin:$PATH
        export PATH=$GITHUB_WORKSPACE/qc-prebuilts/kernel-build-tools/bin:$PATH

        mkdir -p out

        # GKI Base Config
        make O=out ARCH=arm64 gki_defconfig

        # Merge vendor configs
        bash scripts/kconfig/merge_config.sh -m \
          out/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        make O=out olddefconfig

        echo "===== STARTING FULL COMPILE ====="
        make -j$(nproc) O=out \
          CC=clang \
          LLVM=1 \
          LLVM_IAS=1 \
          V=0

    # ----------------------------------------------------------
    # PACK WITH ANYKERNEL3
    # ----------------------------------------------------------
    - name: Create Flashable ZIP
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git AnyKernel
        cp kernel/oneplus/sm8550/out/arch/arm64/boot/Image AnyKernel/
        cd AnyKernel
        zip -r9 OnePlus12R-Kernel.zip ./*

    # ----------------------------------------------------------
    # UPLOAD RELEASE ARTIFACT
    # ----------------------------------------------------------
    - name: Upload Kernel ZIP
      uses: actions/upload-artifact@v4
      with:
        name: OP12R-Kernel
        path: AnyKernel/OnePlus12R-Kernel.zip
