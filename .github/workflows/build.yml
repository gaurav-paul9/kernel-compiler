name: Build OnePlus 12R Kernel

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout builder repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends \
          bc bison build-essential flex libssl-dev libncurses-dev \
          device-tree-compiler python3 python3-setuptools \
          wget curl zip unzip xz-utils \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

    - name: Create directory structure
      run: |
        mkdir -p kernel/oneplus/
        mkdir -p sm8550-modules

    - name: Clone Kernel Source
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone sm8550-modules
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 sm8550-modules --depth=1

    - name: Restore ORIGINAL symlink
      run: |
        cd kernel/oneplus/sm8550

        rm -rf kernel/oplus_cpu/thermal

        # ORIGINAL symlink from stock OnePlus kernel sources
        ln -s ../../../sm8550-modules/oplus/kernel/cpu/thermal kernel/oplus_cpu/thermal

        echo "Symlink info:"
        ls -l kernel/oplus_cpu
        echo "Resolved path:"
        readlink -f kernel/oplus_cpu/thermal/Kconfig

    - name: Download Toolchains
      run: |
        mkdir toolchains
        cd toolchains

        # ARM GNU
        wget -q https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
        tar -xf arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
        rm -f arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz

        # Clang r450784e
        wget -q https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/clang-r450784e.tar.gz
        tar -xf clang-r450784e.tar.gz
        rm -f clang-r450784e.tar.gz

    - name: Generate defconfig
      run: |
        cd kernel/oneplus/sm8550

        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        mkdir -p out

        make O=$O ARCH=arm64 gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          out/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        make O=$O ARCH=arm64 olddefconfig

    - name: Build kernel
      run: |
        cd kernel/oneplus/sm8550

        export ARCH=arm64
        export SUBARCH=arm64
        export O=out

        export CLANG_PATH=$GITHUB_WORKSPACE/toolchains/clang-r450784e/bin
        export ARM_GNU=$(find $GITHUB_WORKSPACE/toolchains -maxdepth=1 -type d -name "arm-gnu-toolchain-*")
        export PATH=$CLANG_PATH:$ARM_GNU/bin:$PATH

        export CROSS_COMPILE=aarch64-none-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CC=clang
        export LD=ld.lld
        export LLVM=1

        make -j$(nproc) O=$O ARCH=arm64

    - name: Build DTBs
      run: |
        cd kernel/oneplus/sm8550
        make -j$(nproc) O=out ARCH=arm64 dtbs

    - name: Create Image.gz-dtb
      run: |
        cd kernel/oneplus/sm8550
        BOOT=out/arch/arm64/boot

        gzip -c $BOOT/Image > $BOOT/Image.gz

        DTB=$(find out/arch/arm64/boot/dts -name "*.dtb" | head -n1)
        cat $BOOT/Image.gz $DTB > $BOOT/Image.gz-dtb

    - name: Package AnyKernel3
      run: |
        cd kernel/oneplus/sm8550
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3

        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        cd AnyKernel3
        zip -r9 $GITHUB_WORKSPACE/OnePlus12R-Kernel.zip .

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "build-${{ github.run_id }}"
        files: OnePlus12R-Kernel.zip
