name: Build OnePlus 12R Kernel (GKI)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Prepare environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git curl xz-utils lz4 libelf-dev build-essential bc flex bison \
          dwarves python3 device-tree-compiler ccache

    - name: Create workspace
      run: |
        mkdir -p kernel/oneplus
        mkdir -p toolchains

    - name: Clone kernel source
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550 \
          kernel/oneplus/sm8550 --depth=1

    - name: Clone kernel modules
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules \
          kernel/oneplus/sm8550-modules --depth=1

    - name: Clone Alphadroid Clang r547379
      run: |
        cd toolchains
        git clone https://gitlab.com/alphadroid-project/prebuilts_clang_host_linux-x86_clang-r547379.git clang --depth=1
        cd ..

    - name: Setup Clang
      run: |
        export PATH=$GITHUB_WORKSPACE/toolchains/clang/bin:$PATH
        echo "PATH=$PATH" >> $GITHUB_ENV

    - name: Configure Kernel (mrproper + defconfigs)
      run: |
        KERNEL=kernel/oneplus/sm8550
        OUT=$KERNEL/out

        cd $KERNEL

        # Full clean â€“ fixes "source tree is not clean"
        make mrproper

        mkdir -p $OUT

        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        export CXX=clang++
        export LLVM=1
        export LLVM_IAS=1

        echo "Using GKI defconfig + vendor configs"

        make O=$OUT gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          $OUT/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        make O=$OUT olddefconfig

    - name: Build kernel
      run: |
        KERNEL=kernel/oneplus/sm8550
        OUT=$KERNEL/out
        THREADS=$(nproc --all)

        export ARCH=arm64
        export SUBARCH=arm64
        export CC=clang
        export CXX=clang++
        export LLVM=1
        export LLVM_IAS=1
        export PATH=$GITHUB_WORKSPACE/toolchains/clang/bin:$PATH

        cd $KERNEL

        make -j$THREADS O=$OUT

    - name: Prepare AnyKernel3 package
      run: |
        cd kernel
        git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1

        # Copy kernel image(s)
        cp oneplus/sm8550/out/arch/arm64/boot/Image* AnyKernel3/ || true
        cp oneplus/sm8550/out/arch/arm64/boot/dtbo.img AnyKernel3/ || true

    - name: Upload Flashable Kernel
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus12R-GKI-Kernel
        path: kernel/AnyKernel3/*
