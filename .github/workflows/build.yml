name: Build OnePlus 12R Kernel (QC Clang)

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install host packages & cross compilers
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends \
          git wget curl bc bison flex build-essential zip unzip \
          libssl-dev libncurses5-dev libncursesw5-dev libelf-dev zlib1g-dev \
          dwarves python3 python3-distutils pkg-config \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi g++-arm-linux-gnueabi

    - name: Prepare directories
      run: |
        mkdir -p qc-prebuilts
        mkdir -p kernel/oneplus

    - name: Clone QC prebuilts (clang + kernel build-tools)
      run: |
        git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 qc-prebuilts/clang || true
        git clone --depth=1 https://git.codelinaro.org/clo/la/kernel/prebuilts/build-tools qc-prebuilts/kernel-build-tools || true

    - name: Detect QC clang
      id: detect_clang
      run: |
        CLANG_BIN=$(find qc-prebuilts/clang -type f -name clang -perm /111 | head -n 1 || true)
        if [ -z "$CLANG_BIN" ]; then
          echo "ERROR: clang not found in QC prebuilts"
          exit 1
        fi
        CLANG_DIR=$(dirname "$CLANG_BIN")
        echo "clang_dir=$CLANG_DIR" >> $GITHUB_OUTPUT
        echo "$CLANG_DIR" >> $GITHUB_PATH
        echo "$PWD/qc-prebuilts/kernel-build-tools/bin" >> $GITHUB_PATH

    - name: Verify clang version
      run: |
        clang --version || true

    - name: Clone kernel + modules
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Clean kernel source (mrproper resets everything)
      working-directory: kernel/oneplus/sm8550
      run: |
        git reset --hard
        git clean -fdx
        make ARCH=arm64 mrproper || true
        rm -rf out || true

    - name: Create CI fragment & fix symlink (AFTER CLEAN)
      working-directory: kernel/oneplus/sm8550
      run: |
        mkdir -p kernel/oplus_cpu || true
        rm -f kernel/oplus_cpu/thermal || true
        ln -s ../../../sm8550-modules/oplus/kernel/cpu/thermal kernel/oplus_cpu/thermal

        mkdir -p ci_fragments
        printf "%s\n" \
          "# CONFIG_OPLUS_FEATURE_DUMP_DEVICE_INFO is not set" \
          "# CONFIG_OPLUS_FEATURE_THEIA is not set" \
          "# CONFIG_OPLUS_FEATURE_FEEDBACK is not set" \
          "# CONFIG_DEBUG_INFO_BTF is not set" \
          > ci_fragments/disable_oplus_ci.config

    - name: Create base config + merge vendor configs
      working-directory: kernel/oneplus/sm8550
      run: |
        export O=out
        mkdir -p $O

        make O=$O ARCH=arm64 gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          $O/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config \
          ci_fragments/disable_oplus_ci.config

        make O=$O ARCH=arm64 olddefconfig

    - name: Build kernel + modules with QC clang
      working-directory: kernel/oneplus/sm8550
      env:
        ARCH: arm64
        O: out
      run: |
        CLANG_DIR="${{ steps.detect_clang.outputs.clang_dir }}"
        export PATH="$CLANG_DIR:$GITHUB_WORKSPACE/qc-prebuilts/kernel-build-tools/bin:$PATH"

        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CLANG_TRIPLE=aarch64-linux-gnu-

        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip

        KCFLAGS="-Wno-frame-larger-than="

        make -j$(nproc) O=$O ARCH=arm64 KCFLAGS="$KCFLAGS"

        rm -rf modules_tmp || true
        mkdir -p modules_tmp
        make O=$O ARCH=arm64 modules_install INSTALL_MOD_PATH=$PWD/modules_tmp

    - name: Package AnyKernel flashable ZIP
      run: |
        rm -rf AnyKernel || true
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel

        IMG=""
        if [ -f kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz ]; then
          IMG=kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz
        elif [ -f kernel/oneplus/sm8550/out/arch/arm64/boot/Image ]; then
          IMG=kernel/oneplus/sm8550/out/arch/arm64/boot/Image
        fi

        [ -n "$IMG" ] && cp "$IMG" AnyKernel/

        cp kernel/oneplus/sm8550/out/arch/arm64/boot/dtbo.img AnyKernel/ 2>/dev/null || true

        mkdir -p AnyKernel/modules
        cp -r kernel/oneplus/sm8550/modules_tmp/lib/modules/* AnyKernel/modules/ 2>/dev/null || true

        cd AnyKernel
        zip -r9 "../OnePlus12R-Kernel-$(date -u +%Y%m%dT%H%M%SZ).zip" ./*
        cd ..

    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: OnePlus12R-Kernel
        path: OnePlus12R-Kernel-*.zip
