name: Build OnePlus 12R Kernel (LLVM Only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout workflow
      uses: actions/checkout@v3
      with:
        fetch-depth: 1

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends \
          bc bison flex build-essential zip unzip \
          libssl-dev python3 python3-pip libc6-dev \
          libncurses5-dev libncursesw5-dev libelf-dev zlib1g-dev dwarves \
          git wget make pkg-config

    - name: Create directory structure
      run: mkdir -p kernel/oneplus

    - name: Clone kernel source (sm8550)
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone kernel modules (sm8550-modules)
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Add CI config fragment
      run: |
        mkdir -p kernel/oneplus/sm8550/ci_fragments
        printf "%s\n" \
          "# Disable problematic Oplus devinfo modules for CI" \
          "# CONFIG_OPLUS_FEATURE_DUMP_DEVICE_INFO is not set" \
          "# CONFIG_OPLUS_FEATURE_THEIA is not set" \
          "# CONFIG_OPLUS_FEATURE_FEEDBACK is not set" \
          "# CONFIG_DEBUG_INFO_BTF is not set" \
          > kernel/oneplus/sm8550/ci_fragments/disable_oplus_ci.config

    - name: Download AOSP Clang (LLVM 20 - r547379)
      run: |
        mkdir -p toolchains/clang
        git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 clang-src --depth=1
        cd clang-src
        git fetch origin refs/tags/llvm-r547379-release --depth=1
        git checkout FETCH_HEAD
        git archive HEAD | tar -x -C ../toolchains/clang
        cd ..
        rm -rf clang-src

    - name: Add Clang to PATH
      run: echo "$PWD/toolchains/clang/bin" >> $GITHUB_PATH

    - name: Verify Clang version
      run: clang --version

    - name: Build kernel (LLVM-only)
      working-directory: kernel/oneplus/sm8550
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        export KCONFIG_CONFIG=$O/.config

        make mrproper
        mkdir -p $O

        make O=$O ARCH=arm64 gki_defconfig

        bash scripts/kconfig/merge_config.sh -m \
          $O/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config \
          ci_fragments/disable_oplus_ci.config

        make O=$O ARCH=arm64 olddefconfig

        make -j$(nproc) O=$O ARCH=arm64 \
          CC=clang \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          STRIP=llvm-strip \
          KCFLAGS="-Wno-frame-larger-than="

    - name: Prepare AnyKernel3 zip
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git --depth=1 anykernel

        IMG=""
        if [ -f kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz ]; then
          IMG=kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz
        elif [ -f kernel/oneplus/sm8550/out/arch/arm64/boot/Image ]; then
          IMG=kernel/oneplus/sm8550/out/arch/arm64/boot/Image
        fi

        cp "$IMG" anykernel/

        cd anykernel
        zip -r9 "../OnePlus12R-Kernel-$(date +%Y%m%d-%H%M).zip" ./*
        cd ..

    - name: Upload release
      uses: softprops/action-gh-release@v1
      with:
        files: OnePlus12R-Kernel-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
