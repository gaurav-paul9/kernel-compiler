name: Build OnePlus 12R Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison flex build-essential zip unzip \
          libssl-dev python3 python3-pip libc6-dev libncurses5-dev libncursesw5-dev

    - name: Create directory structure
      run: |
        mkdir -p kernel/oneplus

    - name: Clone kernel source (sm8550)
      run: |
        git clone https://github.com/gaurav-paul9/android_kernel_oneplus_sm8550.git \
          -b lineage-23.0 kernel/oneplus/sm8550 --depth=1

    - name: Clone kernel modules (sm8550-modules)
      run: |
        git clone https://github.com/LineageOS/android_kernel_oneplus_sm8550-modules.git \
          -b lineage-23.0 kernel/oneplus/sm8550-modules --depth=1

    - name: Download toolchains
      run: |
        mkdir -p toolchains/clang
        mkdir -p toolchains/gcc

        echo "Downloading GCC 14.2"
        wget -q https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/arm-gnu-toolchain-14.2.rel1-x86_64-aarch64-none-linux-gnu.tar.xz -O toolchains/gcc.tar.xz

        echo "Downloading Clang r450784e"
        wget -q https://github.com/ravindu644/Android-Kernel-Tutorials/releases/download/toolchains/clang-r450784e.tar.gz -O toolchains/clang.tar.gz

        echo "Extracting GCC..."
        tar -xf toolchains/gcc.tar.xz -C toolchains/gcc --strip-components=1

        echo "Extracting Clang..."
        tar -xf toolchains/clang.tar.gz -C toolchains/clang --strip-components=0

        echo "Toolchain extraction complete:"
        ls -al toolchains/clang

    - name: Export PATH
      run: |
        echo "$PWD/toolchains/clang/bin" >> $GITHUB_PATH
        echo "$PWD/toolchains/gcc/bin" >> $GITHUB_PATH

    - name: Build kernel
      working-directory: kernel/oneplus/sm8550
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        export KCONFIG_CONFIG=$O/.config

        echo "Cleaning source tree..."
        make mrproper

        mkdir -p $O

        echo "=== gki_defconfig ==="
        make O=$O ARCH=arm64 gki_defconfig

        echo "=== merge vendor configs ==="
        bash scripts/kconfig/merge_config.sh -m \
          $O/.config \
          arch/arm64/configs/vendor/kalama_GKI.config \
          arch/arm64/configs/vendor/oplus/kalama_GKI.config \
          arch/arm64/configs/vendor/debugfs.config

        echo "=== Running olddefconfig ==="
        make O=$O ARCH=arm64 olddefconfig

        echo "=== Building Kernel Image ==="
        make -j$(nproc) O=$O ARCH=arm64 \
          CC=clang \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          STRIP=llvm-strip \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-none-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-none-linux-gnueabi-

    - name: Clone AnyKernel3
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git --depth=1 anykernel
        rm -rf anykernel/modules
        cp kernel/oneplus/sm8550/out/arch/arm64/boot/Image.gz anykernel/

    - name: Create flashable ZIP
      run: |
        cd anykernel
        zip -r9 "../OnePlus12R-Kernel.zip" * -x .git README.md

    - name: Upload kernel zip to Release
      uses: softprops/action-gh-release@v1
      with:
        files: OnePlus12R-Kernel.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
